<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>CHEFS Plugin Embed</h1>
            <nav>
                <a href="/">Public Page</a>
                <a href="/protected">Protected Page</a>
                <a href="/chefs-embed">CHEFS Embed</a>
                <a href="/chefs-embed-plugins">Plugin Directory</a>
                <a href="/auth/logout">Logout</a>
                <span class="user-info">Logged in as: <%= user.username %></span>
            </nav>
        </header>
        
        <main>
            <div class="content">
                <h2><%= plugin?.name || "CHEFS Plugin" %></h2>
                <% if (plugin?.description) { %>
                    <p><%= plugin.description %></p>
                <% } %>
                
                <% if (error) { %>
                    <div class="info-box error">
                        <h3>Error</h3>
                        <p><%= error %></p>
                    </div>
                <% } else { %>
                    <div id="form-container">
                        <chefs-form-viewer></chefs-form-viewer>
                    </div>

                    <!-- Load the CHEFS Form Viewer component -->
                    <script src="<%= baseUrl %>/embed/chefs-form-viewer.js"></script>

                    <!-- Plugin wiring stays isolated here -->
                    <% if (plugin) { %>
                    <script type="module">
                        import { initUserTokenRefresh } from "/lib/user-token-refresh.js";

                        (async () => {
                            try {
                                const modulePath = "<%= plugin ? plugin.modulePath : '' %>";
                                const { register } = await import(modulePath);

                                const requestContext = <%- JSON.stringify(requestContext || {}) %>;

                                const { config = {}, handlers = {} } = register({
                                    request: requestContext,
                                });

                                customElements.whenDefined("chefs-form-viewer").then(() => {
                                    const viewer = document.querySelector("chefs-form-viewer");

                                    // Required attributes from platform (unchanged)
                                    viewer.setAttribute("form-id", "<%= formId %>");
                                    viewer.setAttribute("auth-token", "<%= authToken %>");
                                    viewer.setAttribute("base-url", "<%= baseUrl %>");

                                    // Plugin-owned shaping: set only attributes explicitly provided by the plugin
                                    const attrMap = [
                                        { key: "token", attr: "token", json: true },
                                        { key: "user", attr: "user", json: true },
                                        { key: "headers", attr: "headers", json: true },
                                        { key: "hostData", attr: "host-data", json: true },
                                        { key: "themeCss", attr: "theme-css" },
                                        { key: "language", attr: "language" },
                                        { key: "submissionId", attr: "submission-id" },
                                        { key: "readOnly", attr: "read-only" },
                                        { key: "noShadow", attr: "no-shadow" },
                                        { key: "debug", attr: "debug" },
                                        { key: "isolateStyles", attr: "isolate-styles" },
                                        { key: "noIcons", attr: "no-icons" },
                                        { key: "submitButtonKey", attr: "submit-button-key" },
                                        { key: "printButtonKey", attr: "print-button-key" },
                                        { key: "printEventName", attr: "print-event-name" },
                                        { key: "autoReloadOnSubmit", attr: "auto-reload-on-submit" },
                                        { key: "submitMode", attr: "submit-mode" },
                                    ];

                                    attrMap.forEach(({ key, attr, json }) => {
                                        if (config[key] !== undefined && config[key] !== null) {
                                            const value = json ? JSON.stringify(config[key]) : config[key];
                                            viewer.setAttribute(attr, value);
                                        }
                                    });

                                    // Wire plugin event handlers (plugin can cancel/waitUntil)
                                    Object.entries(handlers).forEach(([eventName, fn]) => {
                                        if (typeof fn === "function") {
                                            viewer.addEventListener(eventName, (event) =>
                                                fn({ event, viewer, request: requestContext })
                                            );
                                        }
                                    });

                                    // Initialize automatic user token refresh if plugin has tokenRefresh config.
                                    // The plugin's OIDC configuration is registered server-side at startup.
                                    // If the plugin does not have tokenRefresh.oidc, refresh is disabled.
                                    <% if (plugin?.tokenRefresh?.oidc) { %>
                                    initUserTokenRefresh(viewer, {
                                        pluginId: "<%= plugin.slug %>",
                                        initialToken: requestContext.bearerToken,
                                        buffer: <%= plugin.tokenRefresh.buffer || 60 %>,
                                        onRefreshFailed: (reason) => {
                                            console.warn("[chefs-embed] Token refresh failed:", reason);
                                            // Could redirect to login if needed:
                                            // window.location.href = "/auth/login?returnTo=" + encodeURIComponent(window.location.href);
                                        },
                                        onRefreshSuccess: () => {
                                            console.log("[chefs-embed] User token refreshed");
                                        }
                                    });
                                    <% } else { %>
                                    console.log("[chefs-embed] Token refresh not configured for this plugin");
                                    <% } %>

                                    // Explicitly load the form to avoid auto-load reliance
                                    if (typeof viewer.load === "function") {
                                        viewer.load();
                                    }
                                });
                            } catch (err) {
                                console.error("Failed to load plugin module", err);
                                const container = document.getElementById("form-container");
                                if (container) {
                                    const msg = document.createElement("div");
                                    msg.className = "info-box error";
                                    msg.innerHTML = "<h3>Plugin load failed</h3><p>Check console for details.</p>";
                                    container.prepend(msg);
                                }
                            }
                        })();
                    </script>
                    <% } else { %>
                    <p>No plugin selected. Please choose one from the <a href="/chefs-embed-plugins">Plugin Directory</a>.</p>
                    <% } %>
                <% } %>
            </div>
        </main>
    </div>
</body>
</html>
